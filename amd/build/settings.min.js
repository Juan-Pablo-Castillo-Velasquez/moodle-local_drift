/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author    Guillermo Leon Alvarez Salamanca
 * @copyright Copyright (c) 2018 Open LMS (https://www.openlms.net)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_drift/settings",["jquery","core/str","core/modal_factory","core/templates","local_drift/drift"],(function($,str,ModalFactory,Templates,drift){return{init:function(clientKey){var div=$("#admin-clientkey"),row=$("<div></div>").attr("class","form-setting"),offset=$("<div></div>").attr("class","form-select"),button=$("<button>Test connection</button>").attr("id","drift_test_connection");div.hasClass("row")&&(row.attr("class","row"),offset.attr("class","offset-sm-3 col-sm-3"),button.css("margin-bottom","1em")),button.attr("class","btn btn-primary").attr("type","submit"),offset.append(button),row.append(offset);var disableButton=function(text){$(button).attr("disabled","disabled"),$(button).text(text)},strings=str.get_strings([{key:"drift_testconnection",component:"local_drift"},{key:"drift_buttondisabled",component:"local_drift"}]);$.when(strings).done((function(localizedStrings){var input=$("#id_s_local_drift_clientkey");""==input.val()?disableButton(localizedStrings[1]):button.text(localizedStrings[0]),$(input).on("input",(function(){disableButton(localizedStrings[1])}))}));var modalStrings=str.get_strings([{key:"drift_testconnection",component:"local_drift"},{key:"drift_connection_verified",component:"local_drift"},{key:"drift_connection_fail",component:"local_drift"}]),localizedModalStrings=[];$.when(modalStrings).done((function(localizedStrings){localizedModalStrings=localizedStrings,ModalFactory.create({title:localizedStrings[0],body:Templates.render("local_drift/settings",{}),type:ModalFactory.types.DEFAULT},button).done((function(){div.append(row)}))})),button.click((function(e){e.preventDefault(),setDefault(),$("#drift_result").text("...");var s=drift.getScript(clientKey);if(M.cfg.behatsiterunning){var path=M.cfg.wwwroot+"/local/drift/tests/fixtures/";s.src=clientKey.trim()=="right-password".trim()?path+"dummy-drift.js":path+"empty.js"}$.get(s.src).done((function(){whenTrue(modalExist,20).then((function(){changeModal(!0,localizedModalStrings[1])})),drift.testConnection(clientKey)})).fail((function(){whenTrue(modalExist,20).then((function(){changeModal(!1,localizedModalStrings[2])}))}))}));var modalExist=function(){return 0!==$("#drift_testing").length},changeModal=function(status,string){swapClasses(status),$("#drift_result").text(string)},whenTrue=function(evaluateFunction,maxIterations){maxIterations=maxIterations||10;var prom=$.Deferred(),i=0,checker=setInterval((function(){(i+=1)>maxIterations?(prom.reject(),clearInterval(checker)):evaluateFunction()&&(prom.resolve(),clearInterval(checker))}),1e3);return prom.promise()},swapClasses=function(status){var selector="#drift_testing";status?$(selector).hasClass("alert-warning")?$(selector).removeClass("alert-warning").addClass("alert-success"):$(selector).hasClass("alert-danger")&&$(selector).removeClass("alert-danger").addClass("alert-success"):$(selector).hasClass("alert-warning")?$(selector).removeClass("alert-warning").addClass("alert-danger"):$(selector).hasClass("alert-success")&&$(selector).removeClass("alert-success").addClass("alert-danger")},setDefault=function(){var selector="#drift_testing";$(selector).hasClass("alert-success")?$(selector).removeClass("alert-success").addClass("alert-warning"):$(selector).hasClass("alert-danger")&&$(selector).removeClass("alert-danger").addClass("alert-warning")}}}}));

//# sourceMappingURL=settings.min.js.map