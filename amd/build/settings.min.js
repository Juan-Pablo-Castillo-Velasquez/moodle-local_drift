define(["jquery","core/str","core/modal_factory","core/templates","local_drift/drift"],function(a,b,c,d,e){return{init:function(f){var g=a("#admin-clientkey"),h=a("<div></div>").attr("class","form-setting"),i=a("<div></div>").attr("class","form-select"),j=a("<button>Test connection</button>").attr("id","drift_test_connection");g.hasClass("row")&&(h.attr("class","row"),i.attr("class","offset-sm-3 col-sm-3"),j.css("margin-bottom","1em")),j.attr("class","btn btn-primary").attr("type","submit"),i.append(j),h.append(i);var k=function(b){a(j).attr("disabled","disabled"),a(j).text(b)},l=b.get_strings([{key:"drift_testconnection",component:"local_drift"},{key:"drift_buttondisabled",component:"local_drift"}]);a.when(l).done(function(b){var c=a("#id_s_local_drift_clientkey");""==c.val()?k(b[1]):j.text(b[0]),a(c).on("input",function(){k(b[1])})});var m=b.get_strings([{key:"drift_testconnection",component:"local_drift"},{key:"drift_connection_verified",component:"local_drift"},{key:"drift_connection_fail",component:"local_drift"}]),n=[];a.when(m).done(function(a){n=a,c.create({title:a[0],body:d.render("local_drift/settings",{}),type:c.types.DEFAULT},j).done(function(a){g.append(h)})}),j.click(function(b){b.preventDefault(),s(),a("#drift_result").text("...");var c=e.getScript(f);if(M.cfg.behatsiterunning){var d=M.cfg.wwwroot+"/local/drift/tests/fixtures/";c.src=f.trim()=="right-password".trim()?d+"dummy-drift.js":d+"empty.js"}a.get(c.src).done(function(){q(o,20).then(function(){p(!0,n[1])}),e.testConnection(f)}).fail(function(){q(o,20).then(function(){p(!1,n[2])})})});var o=function(){return 0!==a("#drift_testing").length},p=function(b,c){r(b),a("#drift_result").text(c)},q=function(b,c){c=c?c:10;var d=a.Deferred(),e=0,f=setInterval(function(){e+=1,e>c?(d.reject(),clearInterval(f)):b()&&(d.resolve(),clearInterval(f))},1e3);return d.promise()},r=function(b){var c="#drift_testing";b?a(c).hasClass("alert-warning")?a(c).removeClass("alert-warning").addClass("alert-success"):a(c).hasClass("alert-danger")&&a(c).removeClass("alert-danger").addClass("alert-success"):a(c).hasClass("alert-warning")?a(c).removeClass("alert-warning").addClass("alert-danger"):a(c).hasClass("alert-success")&&a(c).removeClass("alert-success").addClass("alert-danger")},s=function(){var b="#drift_testing";a(b).hasClass("alert-success")?a(b).removeClass("alert-success").addClass("alert-warning"):a(b).hasClass("alert-danger")&&a(b).removeClass("alert-danger").addClass("alert-warning")}}}});