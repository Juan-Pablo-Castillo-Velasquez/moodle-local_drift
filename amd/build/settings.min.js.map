{"version":3,"sources":["../src/settings.js"],"names":["define","$","str","ModalFactory","Templates","drift","init","clientKey","div","row","attr","offset","button","hasClass","css","append","disableButton","text","strings","get_strings","key","component","when","done","localizedStrings","input","val","on","modalStrings","localizedModalStrings","create","title","body","render","type","types","DEFAULT","click","e","preventDefault","setDefault","s","getScript","M","cfg","behatsiterunning","path","wwwroot","src","trim","get","whenTrue","modalExist","then","changeModal","testConnection","fail","length","status","string","swapClasses","evaluateFunction","maxIterations","prom","Deferred","i","checker","setInterval","reject","clearInterval","resolve","promise","removeClass","addClass"],"mappings":"AA0BAA,OAAM,wBAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,oBAAvB,CAA6C,gBAA7C,CAA+D,mBAA/D,CAAD,CACF,SAASC,CAAT,CAAYC,CAAZ,CAAiBC,CAAjB,CAA+BC,CAA/B,CAA0CC,CAA1C,CAAiD,CAC7C,MAAO,CACHC,IAAI,CAAG,cAASC,CAAT,CAAoB,IAGnBC,CAAAA,CAAG,CAAGP,CAAC,CAAC,kBAAD,CAHY,CAInBQ,CAAG,CAAGR,CAAC,CAAC,aAAD,CAAD,CAAiBS,IAAjB,CAAsB,OAAtB,CAA+B,cAA/B,CAJa,CAKnBC,CAAM,CAAIV,CAAC,CAAC,aAAD,CAAD,CAAiBS,IAAjB,CAAsB,OAAtB,CAA+B,aAA/B,CALS,CAMnBE,CAAM,CAAGX,CAAC,CAAC,kCAAD,CAAD,CAAsCS,IAAtC,CAA2C,IAA3C,CAAiD,uBAAjD,CANU,CAQvB,GAAIF,CAAG,CAACK,QAAJ,CAAa,KAAb,CAAJ,CAAyB,CACrBJ,CAAG,CAACC,IAAJ,CAAS,OAAT,CAAkB,KAAlB,EACAC,CAAM,CAACD,IAAP,CAAY,OAAZ,CAAqB,sBAArB,EACAE,CAAM,CAACE,GAAP,CAAW,eAAX,CAA4B,KAA5B,CACH,CACDF,CAAM,CAACF,IAAP,CAAY,OAAZ,CAAqB,iBAArB,EAAwCA,IAAxC,CAA6C,MAA7C,CAAqD,QAArD,EACAC,CAAM,CAACI,MAAP,CAAcH,CAAd,EACAH,CAAG,CAACM,MAAJ,CAAWJ,CAAX,EAfuB,GAkBnBK,CAAAA,CAAa,CAAG,SAASC,CAAT,CAAe,CAC/BhB,CAAC,CAACW,CAAD,CAAD,CAAUF,IAAV,CAAe,UAAf,CAA2B,UAA3B,EACAT,CAAC,CAACW,CAAD,CAAD,CAAUK,IAAV,CAAeA,CAAf,CACH,CArBsB,CAwBnBC,CAAO,CAAGhB,CAAG,CAACiB,WAAJ,CAAgB,CAC1B,CAACC,GAAG,CAAE,sBAAN,CAA8BC,SAAS,CAAE,aAAzC,CAD0B,CAE1B,CAACD,GAAG,CAAE,sBAAN,CAA8BC,SAAS,CAAE,aAAzC,CAF0B,CAAhB,CAxBS,CA8BvBpB,CAAC,CAACqB,IAAF,CAAOJ,CAAP,EAAgBK,IAAhB,CAAqB,SAASC,CAAT,CAA2B,CAE5C,GAAIC,CAAAA,CAAK,CAAGxB,CAAC,CAAC,6BAAD,CAAb,CAGA,GAAmB,EAAf,EAAAwB,CAAK,CAACC,GAAN,EAAJ,CAAuB,CACnBV,CAAa,CAACQ,CAAgB,CAAC,CAAD,CAAjB,CAChB,CAFD,IAEO,CACHZ,CAAM,CAACK,IAAP,CAAYO,CAAgB,CAAC,CAAD,CAA5B,CACH,CAGDvB,CAAC,CAACwB,CAAD,CAAD,CAASE,EAAT,CAAY,OAAZ,CAAqB,UAAW,CAC5BX,CAAa,CAACQ,CAAgB,CAAC,CAAD,CAAjB,CAChB,CAFD,CAIH,CAhBD,EA9BuB,GAiDnBI,CAAAA,CAAY,CAAG1B,CAAG,CAACiB,WAAJ,CAAgB,CAC/B,CAACC,GAAG,CAAE,sBAAN,CAA8BC,SAAS,CAAE,aAAzC,CAD+B,CAE/B,CAACD,GAAG,CAAE,2BAAN,CAAmCC,SAAS,CAAE,aAA9C,CAF+B,CAG/B,CAACD,GAAG,CAAE,uBAAN,CAA+BC,SAAS,CAAE,aAA1C,CAH+B,CAAhB,CAjDI,CAuDnBQ,CAAqB,CAAG,EAvDL,CA0DvB5B,CAAC,CAACqB,IAAF,CAAOM,CAAP,EAAqBL,IAArB,CAA0B,SAASC,CAAT,CAA2B,CACjDK,CAAqB,CAAGL,CAAxB,CACArB,CAAY,CAAC2B,MAAb,CAAoB,CAChBC,KAAK,CAAEP,CAAgB,CAAC,CAAD,CADP,CAEhBQ,IAAI,CAAE5B,CAAS,CAAC6B,MAAV,CAAiB,sBAAjB,CAAyC,EAAzC,CAFU,CAGhBC,IAAI,CAAE/B,CAAY,CAACgC,KAAb,CAAmBC,OAHT,CAApB,CAIGxB,CAJH,EAIWW,IAJX,CAIgB,UAAU,CAEtBf,CAAG,CAACO,MAAJ,CAAWN,CAAX,CACH,CAPD,CAQH,CAVD,EAYAG,CAAM,CAACyB,KAAP,CAAa,SAASC,CAAT,CAAY,CACrBA,CAAC,CAACC,cAAF,GACAC,CAAU,GACVvC,CAAC,CAAC,eAAD,CAAD,CAAmBgB,IAAnB,CAAwB,KAAxB,EACA,GAAIwB,CAAAA,CAAC,CAAGpC,CAAK,CAACqC,SAAN,CAAgBnC,CAAhB,CAAR,CACA,GAAIoC,CAAC,CAACC,GAAF,CAAMC,gBAAV,CAA4B,CACxB,GAAIC,CAAAA,CAAI,CAAGH,CAAC,CAACC,GAAF,CAAMG,OAAN,CAAgB,8BAA3B,CACAN,CAAC,CAACO,GAAF,CAASzC,CAAS,CAAC0C,IAAV,IAAoB,iBAAiBA,IAAjB,EAArB,CAAgDH,CAAI,CAAG,gBAAvD,CAA0EA,CAAI,CAAG,UAC5F,CACD7C,CAAC,CAACiD,GAAF,CAAMT,CAAC,CAACO,GAAR,EAAazB,IAAb,CAAkB,UAAW,CACzB4B,CAAQ,CAACC,CAAD,CAAa,EAAb,CAAR,CAAyBC,IAAzB,CAA8B,UAAW,CACrCC,CAAW,IAAOzB,CAAqB,CAAC,CAAD,CAA5B,CACd,CAFD,EAGAxB,CAAK,CAACkD,cAAN,CAAqBhD,CAArB,CACH,CALD,EAKGiD,IALH,CAKQ,UAAY,CAChBL,CAAQ,CAACC,CAAD,CAAa,EAAb,CAAR,CAAyBC,IAAzB,CAA8B,UAAW,CACrCC,CAAW,IAAQzB,CAAqB,CAAC,CAAD,CAA7B,CACd,CAFD,CAGH,CATD,CAUH,CAnBD,EAtEuB,GA+FnBuB,CAAAA,CAAU,CAAG,UAAW,CACxB,MAAsC,EAA/B,GAAAnD,CAAC,CAAC,gBAAD,CAAD,CAAoBwD,MAC9B,CAjGsB,CAwGnBH,CAAW,CAAG,SAASI,CAAT,CAAiBC,CAAjB,CAAyB,CACvCC,CAAW,CAACF,CAAD,CAAX,CACAzD,CAAC,CAAC,eAAD,CAAD,CAAmBgB,IAAnB,CAAwB0C,CAAxB,CACH,CA3GsB,CAmHnBR,CAAQ,CAAG,SAASU,CAAT,CAA2BC,CAA3B,CAA0C,CACrDA,CAAa,CAAG,CAACA,CAAD,CAAiB,EAAjB,CAAsBA,CAAtC,CADqD,GAGjDC,CAAAA,CAAI,CAAG9D,CAAC,CAAC+D,QAAF,EAH0C,CAIjDC,CAAC,CAAG,CAJ6C,CAKjDC,CAAO,CAAGC,WAAW,CAAC,UAAW,CACjCF,CAAC,CAAGA,CAAC,CAAG,CAAR,CACA,GAAIA,CAAC,CAAGH,CAAR,CAAuB,CACnBC,CAAI,CAACK,MAAL,GACAC,aAAa,CAACH,CAAD,CAChB,CAHD,IAGO,CACH,GAAIL,CAAgB,EAApB,CAAwB,CACpBE,CAAI,CAACO,OAAL,GACAD,aAAa,CAACH,CAAD,CAChB,CACJ,CACJ,CAXwB,CAWtB,GAXsB,CAL4B,CAkBrD,MAAOH,CAAAA,CAAI,CAACQ,OAAL,EACV,CAtIsB,CA4InBX,CAAW,CAAG,SAASF,CAAT,CAAiB,CAE/B,GAAIA,CAAJ,CAAY,CACR,GAAIzD,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,eAArB,CAAJ,CAA2C,CACvCZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,eAAxB,EAAyCC,QAAzC,CAAkD,eAAlD,CACH,CAFD,IAEO,IAAIxE,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,cAArB,CAAJ,CAA0C,CAC7CZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,cAAxB,EAAwCC,QAAxC,CAAiD,eAAjD,CACH,CACJ,CAND,IAMO,CACH,GAAIxE,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,eAArB,CAAJ,CAA2C,CACvCZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,eAAxB,EAAyCC,QAAzC,CAAkD,cAAlD,CACH,CAFD,IAEO,IAAIxE,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,eAArB,CAAJ,CAA2C,CAC9CZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,eAAxB,EAAyCC,QAAzC,CAAkD,cAAlD,CACH,CACJ,CACJ,CA3JsB,CAgKnBjC,CAAU,CAAG,UAAW,CAExB,GAAIvC,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,eAArB,CAAJ,CAA2C,CACvCZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,eAAxB,EAAyCC,QAAzC,CAAkD,eAAlD,CACH,CAFD,IAEO,IAAIxE,CAAC,kBAAD,CAAYY,QAAZ,CAAqB,cAArB,CAAJ,CAA0C,CAC7CZ,CAAC,kBAAD,CAAYuE,WAAZ,CAAwB,cAAxB,EAAwCC,QAAxC,CAAiD,eAAjD,CACH,CACJ,CACJ,CAzKE,CA4Kd,CA9KK,CAAN","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   local_drift\n * @author    Guillermo Leon Alvarez Salamanca <guillermo.alvarez@blackboard.com>\n * @copyright Copyright (c) 2018 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * JS code to test Drift connection in local_drift settings file.\n */\n\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/templates', 'local_drift/drift'],\n    function($, str, ModalFactory, Templates, drift) {\n        return {\n            init : function(clientKey) {\n\n                // Create button to test drift connection.\n                var div = $('#admin-clientkey');\n                var row = $('<div></div>').attr('class', 'form-setting');\n                var offset =  $('<div></div>').attr('class', 'form-select');\n                var button = $('<button>Test connection</button>').attr('id', 'drift_test_connection');\n                // Some styles and classes for boost theme.\n                if (div.hasClass('row')) {\n                    row.attr('class', 'row');\n                    offset.attr('class', 'offset-sm-3 col-sm-3');\n                    button.css('margin-bottom', '1em');\n                }\n                button.attr('class', 'btn btn-primary').attr('type', 'submit');\n                offset.append(button);\n                row.append(offset);\n\n                // Disable the button.\n                var disableButton = function(text) {\n                    $(button).attr('disabled', 'disabled');\n                    $(button).text(text);\n                };\n\n                // First bring the required stings for the button.\n                var strings = str.get_strings([\n                    {key: 'drift_testconnection', component: 'local_drift'},\n                    {key: 'drift_buttondisabled', component: 'local_drift'}\n                ]);\n\n                // Load button with the right string.\n                $.when(strings).done(function(localizedStrings) {\n                    // Selector of the client key input.\n                    var input = $('#id_s_local_drift_clientkey');\n\n                    // Check if user has stored the client key or not.\n                    if (input.val() == '') {\n                        disableButton(localizedStrings[1]);\n                    } else {\n                        button.text(localizedStrings[0]);\n                    }\n\n                    // Disabled button when a change occurs on the client key.\n                    $(input).on('input', function() {\n                        disableButton(localizedStrings[1]);\n                    });\n\n                });\n\n                // Strings for Modal.\n                var modalStrings = str.get_strings([\n                    {key: 'drift_testconnection', component: 'local_drift'},\n                    {key: 'drift_connection_verified', component: 'local_drift'},\n                    {key: 'drift_connection_fail', component: 'local_drift'}\n                ]);\n\n                var localizedModalStrings = [];\n\n                // Add the modal to DOM when the strings are ready.\n                $.when(modalStrings).done(function(localizedStrings) {\n                    localizedModalStrings = localizedStrings;\n                    ModalFactory.create({\n                        title: localizedStrings[0],\n                        body: Templates.render('local_drift/settings', {}),\n                        type: ModalFactory.types.DEFAULT\n                    }, button).done(function(){\n                        // Append button in the DOM.\n                        div.append(row);\n                    });\n                });\n\n                button.click(function(e) {\n                    e.preventDefault();\n                    setDefault();\n                    $('#drift_result').text('...');\n                    var s = drift.getScript(clientKey);\n                    if (M.cfg.behatsiterunning) {\n                        var path = M.cfg.wwwroot + '/local/drift/tests/fixtures/';\n                        s.src = (clientKey.trim() == 'right-password'.trim()) ? path + 'dummy-drift.js' : path + 'empty.js';\n                    }\n                    $.get(s.src).done(function() {\n                        whenTrue(modalExist, 20).then(function() {\n                            changeModal(true, localizedModalStrings[1]);\n                        });\n                        drift.testConnection(clientKey);\n                    }).fail(function () {\n                        whenTrue(modalExist, 20).then(function() {\n                            changeModal(false, localizedModalStrings[2]);\n                        });\n                    });\n                });\n\n                /**\n                 * Checks if the modal exists in the DOM\n                 * @returns {boolean}\n                 */\n                var modalExist = function() {\n                    return $('#drift_testing').length !== 0;\n                };\n\n                /**\n                 * Change modal class and texts.\n                 * @param {bool} status Response status\n                 * @param string\n                 */\n                var changeModal = function(status, string) {\n                    swapClasses(status);\n                    $('#drift_result').text(string);\n                };\n\n                /**\n                 * Makes a JQuery promise to see if some element exists.\n                 * @param {function} evaluateFunction\n                 * @param {int} maxIterations\n                 * @returns {promise} JQuery promise\n                 */\n                var whenTrue = function(evaluateFunction, maxIterations) {\n                    maxIterations = !maxIterations ? 10 : maxIterations;\n\n                    var prom = $.Deferred();\n                    var i = 0;\n                    var checker = setInterval(function() {\n                        i = i + 1;\n                        if (i > maxIterations) {\n                            prom.reject();\n                            clearInterval(checker);\n                        } else {\n                            if (evaluateFunction()) {\n                                prom.resolve();\n                                clearInterval(checker);\n                            }\n                        }\n                    }, 1000);\n\n                    return prom.promise();\n                };\n\n                /**\n                 * Changes the class of the html element to match the response status.\n                 * @param {bool} status Response status\n                 */\n                var swapClasses = function(status) {\n                    var selector = '#drift_testing';\n                    if (status) {\n                        if ($(selector).hasClass('alert-warning')) {\n                            $(selector).removeClass(\"alert-warning\").addClass('alert-success');\n                        } else if ($(selector).hasClass('alert-danger')) {\n                            $(selector).removeClass(\"alert-danger\").addClass('alert-success');\n                        }\n                    } else {\n                        if ($(selector).hasClass('alert-warning')) {\n                            $(selector).removeClass(\"alert-warning\").addClass('alert-danger');\n                        } else if ($(selector).hasClass('alert-success')) {\n                            $(selector).removeClass(\"alert-success\").addClass('alert-danger');\n                        }\n                    }\n                };\n\n                /**\n                 * Set the default state for the modal\n                 */\n                var setDefault = function() {\n                    var selector = '#drift_testing';\n                    if ($(selector).hasClass('alert-success')) {\n                        $(selector).removeClass(\"alert-success\").addClass('alert-warning');\n                    } else if ($(selector).hasClass('alert-danger')) {\n                        $(selector).removeClass(\"alert-danger\").addClass('alert-warning');\n                    }\n                };\n            }\n\n        };\n});"],"file":"settings.min.js"}